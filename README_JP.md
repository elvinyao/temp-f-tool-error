# Focalboard Tool

## システム機能紹介

Focalboard Toolは、Focalboardカンバンを管理・操作するためのツールサービスです。このシステムはRESTful APIセットを提供し、HTTPリクエストを通じてFocalboardカンバンデータの取得、変更、管理を可能にします。本システムは主にFocalboardとMattermostのAPI統合ツールとして機能し、これらのプラットフォームとの相互作用の複雑さを簡素化します。

### 主な機能

- 単一のボード情報の取得
- ボードデータの設定
- Mattermostとの統合
- 完全なエラー処理とログ記録のサポート

## システムアーキテクチャ図

### システム機能アーキテクチャ図

```
┌─────────────────────┐
│   クライアント      │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐      ┌─────────────────────┐
│  Focalboard Tool    │◄────►│    設定ファイル     │
│  RESTful APIサービス│      │ (application.toml)  │
└─────────┬───────────┘      └─────────────────────┘
          │
          ▼
┌─────────────────────┐      ┌─────────────────────┐
│ サービス層 (Service)│◄────►│    エラー定義       │
└─────────┬───────────┘      │   (errors.yaml)     │
          │                  └─────────────────────┘
          ▼
┌─────────────────────┐
│データアクセス層(DAO)│
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐      ┌─────────────────────┐
│  HTTP APIクライアント│◄────►│    Focalboard      │
└─────────────────────┘      └─────────────────────┘
          │
          ▼
┌─────────────────────┐
│     Mattermost      │
└─────────────────────┘
```

### ビジネスアーキテクチャ図

```
┌───────────────────────────────────────────┐
│            クライアントアプリ             │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│            認証層 (Basic Auth)            │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│               API層                       │
│   ┌─────────────────────────────────┐     │
│   │      /api/v1/focalboard/*       │     │
│   └─────────────────┬───────────────┘     │
└───────────────────┬─┴───────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│             ビジネスロジック層            │
│   ┌─────────────────────────────────┐     │
│   │   設定検証     │   ボード設定   │     │
│   └─────────────────────────────────┘     │
│   ┌─────────────────────────────────┐     │
│   │  エラー処理    │   ログ記録    │     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│           データアクセス層                │
│   ┌─────────────────────────────────┐     │
│   │ Focalboard API │ Mattermost API │     │
│   └─────────────────────────────────┘     │
└───────────────────────────────────────────┘
```

### 技術アーキテクチャ図

```
┌───────────────────────────────────────────┐
│             アプリケーション層            │
│   ┌─────────────────────────────────┐     │
│   │         Gin Webフレームワーク   │     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│             ミドルウェア層               │
│   ┌─────────────────────────────────┐     │
│   │リクエストID│エラー処理│アクセス制御│     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│             コアサービス層               │
│   ┌─────────────────────────────────┐     │
│   │設定管理│ログサービス│エラー管理 │     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│               ツールライブラリ層         │
│   ┌─────────────────────────────────┐     │
│   │HTTPクライアント│ログライブラリ│エラー処理ライブラリ│    │
│   └─────────────────────────────────┘     │
└───────────────────────────────────────────┘
```

## エラー処理

システムには完全なエラー処理メカニズムが実装されており、エラーは2種類に分類されます：

1. **クライアントエラー(client_error)**: クライアントに起因するエラー（パラメータ無効、リソース不存在など）
2. **サーバーエラー(server_error)**: システム内部エラー（データベース接続失敗、API呼び出し失敗など）

エラー設定は `configs/errors.yaml` ファイルで一元的に定義され、エラーコード、HTTPステータスコード、エラーメッセージテンプレートなどが含まれています。

エラー処理フロー：

1. ミドルウェアを使用してAPI要求処理中に発生したすべてのエラーをキャプチャ
2. エラーを標準的なエラーレスポンス形式に変換
3. エラータイプに基づいて異なるレベルのログを記録
4. サーバーエラーの場合、機密性の高いエラー詳細を隠し、基本的なエラー情報のみを返す
5. レスポンスにリクエストIDを含め、問題の追跡を容易にする

## ログ処理

システムはUberのzapログライブラリを使用して高性能なログ記録を実現しています：

1. 複数のログレベルをサポート(DEBUG, INFO, WARN, ERROR, FATAL, PANIC)
2. ログローテーション(log rotation)をサポート（lumberjackを使用）
3. ログ内容にはタイムスタンプ、ログレベル、リクエストID、エラー詳細などの情報が含まれる
4. 設定ファイルを通じてログの動作を調整可能（ファイルサイズ、保持数、保持日数など）

ログ設定は `application.toml` の `[log]` セクションにあります：

```toml
[log]
logLevel = "debug"
useLogRotation = true
[log.logProps]
fileName = "./logs/aa.log"
maxSize = 1
maxBackups = 5
maxAge = 31
```

## APIインターフェースドキュメント

システムはSwaggerドキュメントを統合しており、`/swagger/*` パスにアクセスすることで完全なAPIドキュメントを確認できます。

### 主要APIインターフェース

#### 単一のボード情報を取得

```
GET /api/v1/focalboard/boards/single
```

**パラメータ:**
- `boardId`: ボードID（必須）
- `token`: ユーザー認証トークン（必須）

**レスポンス:**
成功レスポンス(200):
```json
{
  "success": true,
  "data": {
    // ボード情報
  }
}
```

エラーレスポンス:
```json
{
  "success": false,
  "error": {
    "code": "エラーコード",
    "message": "エラーメッセージ",
    "params": {
      "request_id": "リクエストID"
    }
  }
}
```

## 開発ガイド

### 環境設定

1. Go 1.16以上をインストール
2. コードリポジトリをクローン
3. 依存関係をインストール: `go mod download`

### プロジェクト構造

```
├── configs/            # 設定ファイルディレクトリ
│   ├── application.toml # アプリケーション設定
│   └── errors.yaml     # エラー定義
├── internal/           # 内部コード
│   ├── apimodel/       # APIモデル定義
│   ├── appconst/       # アプリケーション定数
│   ├── conf/           # 設定処理
│   ├── dao/            # データアクセス層
│   ├── middleware/     # HTTPミドルウェア
│   ├── model/          # 内部モデル
│   ├── server/         # HTTPサーバー
│   └── service/        # ビジネスロジック
├── library/           # ツールライブラリ
│   ├── log/           # ログ処理
│   └── net/           # ネットワークツール
├── logs/              # ログファイル
├── pkg/               # 公開パッケージ
├── main.go            # エントリーファイル
├── go.mod             # Goモジュール定義
└── go.sum             # 依存関係バージョン固定
```

### 新しいAPIの追加

1. `internal/server/http`に新しいハンドラー関数を作成
2. `route()`関数にルートを追加
3. `internal/service`にビジネスロジックを実装
4. データベースアクセスが必要な場合は、`internal/dao`に対応するメソッドを追加

### エラー処理

新しいエラータイプの追加：
1. `configs/errors.yaml`でエラーを定義
2. `errors`パッケージのメソッドを使用して具体的なエラーを作成

```go
// 使用例
if token == "" {
    return errors.MissingParam("token")
}
```

### 設定管理

設定の変更：
1. `application.toml`に設定項目を追加
2. `internal/conf/conf.go`に対応する構造体フィールドを追加

### ログ記録

ログの使用：
```go
import "focalboard-tool/library/log"

// 異なるレベルのログを記録
log.Debug("デバッグ情報")
log.Info("情報ログ")
log.Warn("警告情報")
log.Error("エラー情報", zap.Error(err))
```

## デプロイガイド

1. アプリケーションをビルド: `go build -o focalboard-tool`
2. `configs/application.toml`ファイルを設定
3. アプリケーションを実行: `./focalboard-tool --config=configs/application.toml`

コマンドラインパラメータ:
- `--config` (`-c`): 設定ファイルパス
- `--expath` (`-e`): 追加設定ファイルパス 