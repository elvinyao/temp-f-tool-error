# Focalboard Tool

## システム機能紹介

Focalboard Toolは、Focalboardカンバンを管理・操作するためのツールサービスです。このシステムは完全なRESTful APIセットを提供し、HTTPリクエストを通じてFocalboardカンバンデータの取得、変更、管理を可能にします。本システムは主にFocalboardとMattermostのAPI統合ツールとして機能し、これらのプラットフォームとの相互作用の複雑さを簡素化します。

### 主な機能

- **ボード管理**：単一ボード情報の取得と設定
- **カード操作**：カードの取得、移動、一括操作
- **ステータス管理**：ステータス別カードフィルタリング、カードステータスの一括移動
- **ユーザーステータス**：ユーザーカスタムステータスの更新
- **関連クエリ**：カード関連のLead情報取得
- **完全なエラー処理とログ記録**
- **Swagger APIドキュメント**
- **Basic Auth認証**

## システムアーキテクチャ図

### システム機能アーキテクチャ図

```
┌─────────────────────┐
│   クライアント      │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐      ┌─────────────────────┐
│  Focalboard Tool    │◄────►│    設定ファイル     │
│  RESTful APIサービス│      │ (application.toml)  │
└─────────┬───────────┘      └─────────────────────┘
          │
          ▼
┌─────────────────────┐      ┌─────────────────────┐
│ サービス層 (Service)│◄────►│    エラー定義       │
└─────────┬───────────┘      │   (errors.yaml)     │
          │                  └─────────────────────┘
          ▼
┌─────────────────────┐
│データアクセス層(DAO)│
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐      ┌─────────────────────┐
│  HTTP APIクライアント│◄────►│    Focalboard      │
└─────────────────────┘      └─────────────────────┘
          │
          ▼
┌─────────────────────┐
│     Mattermost      │
└─────────────────────┘
```

### ビジネスアーキテクチャ図

```
┌───────────────────────────────────────────┐
│            クライアントアプリ             │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│            認証層 (Basic Auth)            │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│               API層                       │
│   ┌─────────────────────────────────┐     │
│   │      /api/v1/focalboard/*       │     │
│   └─────────────────┬───────────────┘     │
└───────────────────┬─┴───────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│             ビジネスロジック層            │
│   ┌─────────────────────────────────┐     │
│   │   設定検証     │   ボード設定   │     │
│   └─────────────────────────────────┘     │
│   ┌─────────────────────────────────┐     │
│   │  エラー処理    │   ログ記録    │     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│           データアクセス層                │
│   ┌─────────────────────────────────┐     │
│   │ Focalboard API │ Mattermost API │     │
│   └─────────────────────────────────┘     │
└───────────────────────────────────────────┘
```

### 技術アーキテクチャ図

```
┌───────────────────────────────────────────┐
│             アプリケーション層            │
│   ┌─────────────────────────────────┐     │
│   │         Gin Webフレームワーク   │     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│             ミドルウェア層               │
│   ┌─────────────────────────────────┐     │
│   │リクエストID│エラー処理│アクセス制御│     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│             コアサービス層               │
│   ┌─────────────────────────────────┐     │
│   │設定管理│ログサービス│エラー管理 │     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│               ツールライブラリ層         │
│   ┌─────────────────────────────────┐     │
│   │HTTPクライアント│ログライブラリ│エラー処理ライブラリ│    │
│   └─────────────────────────────────┘     │
└───────────────────────────────────────────┘
```

## 技術スタック

- **Go** 1.24.3
- **Gin** Webフレームワーク
- **Swagger** APIドキュメント
- **Zap** 高性能ログライブラリ
- **Lumberjack** ログローテーション
- **Focalboard** 公式SDK統合
- **Mattermost** 公式SDK統合

## エラー処理

システムには完全なエラー処理メカニズムが実装されており、エラーは2種類に分類されます：

1. **クライアントエラー(client_error)**: クライアントに起因するエラー（パラメータ無効、リソース不存在など）
2. **サーバーエラー(server_error)**: システム内部エラー（データベース接続失敗、API呼び出し失敗など）

エラー設定は `configs/errors.yaml` ファイルで一元的に定義され、エラーコード、HTTPステータスコード、エラーメッセージテンプレートなどが含まれています。

エラー処理フロー：

1. ミドルウェアを使用してAPI要求処理中に発生したすべてのエラーをキャプチャ
2. エラーを標準的なエラーレスポンス形式に変換
3. エラータイプに基づいて異なるレベルのログを記録
4. サーバーエラーの場合、機密性の高いエラー詳細を隠し、基本的なエラー情報のみを返す
5. レスポンスにリクエストIDを含め、問題の追跡を容易にする

## ログ処理

システムはUberのzapログライブラリを使用して高性能なログ記録を実現しています：

1. 複数のログレベルをサポート(DEBUG, INFO, WARN, ERROR, FATAL, PANIC)
2. ログローテーション(log rotation)をサポート（lumberjackを使用）
3. ログ内容にはタイムスタンプ、ログレベル、リクエストID、エラー詳細などの情報が含まれる
4. 設定ファイルを通じてログの動作を調整可能（ファイルサイズ、保持数、保持日数など）

ログ設定は `application.toml` の `[log]` セクションにあります：

```toml
[log]
logLevel = "debug"
useLogRotation = true
[log.logProps]
fileName = "./logs/aa.log"
maxSize = 1
maxBackups = 5
maxAge = 31
```

## APIインターフェースドキュメント

システムはSwaggerドキュメントを統合しており、`/swagger/*` パスにアクセスすることで完全なAPIドキュメントを確認できます。

### 認証

APIはBasic Auth認証を使用し、デフォルトのユーザー名とパスワード：
- ユーザー名：`admin` / パスワード：`admin`
- ユーザー名：`user` / パスワード：`user`

### 主要APIインターフェース

#### 1. 単一のボード情報を取得

```http
GET /api/v1/focalboard/boards/single
```

**パラメータ:**
- `boardId`: ボードID（必須）
- `token`: ユーザー認証トークン（必須）

**レスポンス例:**
```json
{
  "success": true,
  "data": {
    "id": "board-id",
    "teamId": "team-id",
    "title": "ボードタイトル",
    "cardProperties": [...]
  }
}
```

#### 2. ボードの全カード情報を取得

```http
GET /api/v1/focalboard/boards/cards/allinfo
```

**パラメータ:**
- `boardId`: ボードID（必須）

**説明:** 指定されたボード内のすべてのカードを取得し、プロパティと値を含む

#### 3. ボードカードリストを取得

```http
GET /api/v1/focalboard/boards/cards/list/all
```

**パラメータ:**
- `boardId`: ボードID（必須）

**説明:** ボード内のすべてのカードのリストを取得

#### 4. ステータス別カードフィルタリング

```http
GET /api/v1/focalboard/boards/cards/list/filter/status
```

**パラメータ:**
- `boardId`: ボードID（必須）
- `statusName`: ステータス名（オプション）

**説明:** 指定されたステータスに基づいてボード内のカードをフィルタリング

#### 5. 単一カードの移動

```http
PUT /api/v1/focalboard/boards/cards/move/one
```

**パラメータ:**
- `boardId`: ボードID（必須）
- `asleadId`: Aslead ID（必須）
- `statusName`: 移動先ステータス名（必須）

**説明:** 単一のカードを異なるステータス列に移動

#### 6. カードの一括移動

```http
PUT /api/v1/focalboard/boards/cards/move/batch
```

**パラメータ:**
- `boardId`: ボードID（必須）
- `fromStatusName`: 移動元ステータス名（必須）
- `toStatusName`: 移動先ステータス名（必須）

**説明:** カードを一括で異なるステータス列に移動

#### 7. ユーザーカスタムステータスの更新

```http
PATCH /api/v1/focalboard/boards/one/status/patch
```

**パラメータ:**
- `asleadId`: Aslead ID（必須）
- `statusName`: ステータス名（必須）
- `userToken`: ユーザートークン（必須）

**説明:** ユーザーに新しいカスタムステータスを設定

#### 8. カード関連情報の取得

```http
GET /api/v1/focalboard/cards/single/asleadinfo
```

**パラメータ:**
- `boardId`: ボードID（必須）
- `cardId`: カードID（必須）

**説明:** カードIDとボードIDを使用して関連するLead情報を取得

### エラーレスポンス形式

```json
{
  "success": false,
  "error": {
    "code": "エラーコード",
    "message": "エラーメッセージ",
    "params": {
      "request_id": "リクエストID",
      "timestamp": 1234567890
    }
  }
}
```

## クイックスタート

### インストールと実行

1. **プロジェクトのクローン**
```bash
git clone <repository-url>
cd focalboard-tool
```

2. **依存関係のインストール**
```bash
go mod download
```

3. **設定の構成**
   - `configs/application.toml` をコピーし、必要に応じて設定を変更
   - FocalboardとMattermostサーバーのアドレスが正しいことを確認

4. **サービスの実行**
```bash
go run main.go
```

5. **APIドキュメントへのアクセス**
   - ブラウザで `http://localhost:8080/swagger/index.html` にアクセス

### 設定ファイル

主要な設定は `configs/application.toml` にあります：

```toml
[app]
httpPort = 8080
version = "0.0.1"
appName = "focalboard-tool"
runMode = "debug"

[httpClient.focalboardClient]
addr = "http://your-focalboard-server"
apiVersionPath = "/api/v2"
timeout = "10s"

[httpClient.mattermostClient]
addr = "http://your-mattermost-server"
apiVersionPath = "/api/v4"
timeout = "10s"
```

## 開発ガイド

### プロジェクト構造

```
├── configs/            # 設定ファイルディレクトリ
│   ├── application.toml # アプリケーション設定
│   └── errors.yaml     # エラー定義
├── docs/              # Swaggerドキュメント
├── internal/          # 内部コード
│   ├── apimodel/      # APIモデル定義
│   ├── appconst/      # アプリケーション定数
│   ├── conf/          # 設定処理
│   ├── dao/           # データアクセス層
│   ├── middleware/    # HTTPミドルウェア
│   ├── model/         # 内部モデル
│   ├── server/        # HTTPサーバー
│   └── service/       # ビジネスロジック
├── library/           # ツールライブラリ
├── logs/              # ログファイル
├── pkg/               # 公共パッケージ
├── main.go            # エントリーファイル
├── go.mod             # Goモジュール定義
└── go.sum             # 依存関係バージョンロック
```

### 新しいAPIの追加

1. `internal/server/handler` に新しい処理関数を作成
2. `internal/server/http/focalboard.go` にルートを追加
3. `internal/service` にビジネスロジックを実装
4. `internal/dao` にデータアクセスメソッドを追加
5. Swaggerドキュメントコメントを更新

### エラー処理

新しいエラータイプの追加：
1. `configs/errors.yaml` でエラーを定義
2. `pkg/errors` パッケージのメソッドを使用して具体的なエラーを作成

```go
// 使用例
if token == "" {
    return errors.ConfigMissingParam("token")
}
```

### ログ記録

```go
import (
    "focalboard-tool/library/log"
    "go.uber.org/zap"
)

// 情報の記録
log.Info("操作成功", zap.String("operation", "GetBoard"))

// エラーの記録
log.Error("操作失敗", zap.Error(err), zap.String("boardId", boardId))
```

## デプロイ

### Dockerデプロイ

1. イメージのビルド：
```bash
docker build -t focalboard-tool .
```

2. コンテナの実行：
```bash
docker run -d -p 8080:8080 \
  -v /path/to/config:/app/configs \
  -v /path/to/logs:/app/logs \
  focalboard-tool
```

### 本番環境

1. 設定ファイルの実行モードを `release` に変更
2. 適切なログレベルを設定
3. 適切なタイムアウト時間を設定
4. ロードバランサーと監視を設定

## 監視とメンテナンス

### ヘルスチェック

システムは基本的なヘルスチェックエンドポイントを提供し、監視ツールを通じてサービス状態を確認できます。

### ログ監視

- ログファイルの場所：`./logs/aa.log`
- ログローテーションをサポートし、期限切れのログを自動的にクリーンアップ
- 設定を通じてログ保持ポリシーを調整可能

### パフォーマンス監視

- pprofパフォーマンス分析ツールを統合
- HTTPインターフェースを通じてパフォーマンス指標を確認
- リクエスト追跡とパフォーマンス分析をサポート