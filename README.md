# Focalboard Tool

## 系统功能介绍

Focalboard Tool 是一个用于管理和操作 Focalboard 看板的工具服务。该系统提供了一套RESTful API，允许用户通过HTTP请求来获取、修改和管理Focalboard看板数据。本系统主要作为Focalboard和Mattermost的API集成工具，简化了与这些平台交互的复杂性。

### 主要功能

- 获取单个看板信息
- 配置看板数据
- 与Mattermost集成
- 支持完善的错误处理和日志记录

## 系统架构图

### 系统功能架构图

```
┌─────────────────────┐
│    客户端应用       │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐      ┌─────────────────────┐
│  Focalboard Tool    │◄────►│    配置文件         │
│  RESTful API服务    │      │  (application.toml) │
└─────────┬───────────┘      └─────────────────────┘
          │
          ▼
┌─────────────────────┐      ┌─────────────────────┐
│  服务层 (Service)   │◄────►│    错误定义         │
└─────────┬───────────┘      │   (errors.yaml)     │
          │                  └─────────────────────┘
          ▼
┌─────────────────────┐
│  数据访问层 (DAO)   │
└─────────┬───────────┘
          │
          ▼
┌─────────────────────┐      ┌─────────────────────┐
│  HTTP API客户端     │◄────►│   Focalboard        │
└─────────────────────┘      └─────────────────────┘
          │
          ▼
┌─────────────────────┐
│    Mattermost       │
└─────────────────────┘
```

### 业务架构图

```
┌───────────────────────────────────────────┐
│              客户端应用                    │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│              认证层 (Basic Auth)           │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│              API层                        │
│   ┌─────────────────────────────────┐     │
│   │      /api/v1/focalboard/*       │     │
│   └─────────────────┬───────────────┘     │
└───────────────────┬─┴───────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│              业务逻辑层                    │
│   ┌─────────────────────────────────┐     │
│   │    配置验证       │    看板配置  │     │
│   └─────────────────────────────────┘     │
│   ┌─────────────────────────────────┐     │
│   │    错误处理       │    日志记录  │     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│              数据访问层                    │
│   ┌─────────────────────────────────┐     │
│   │ Focalboard API │ Mattermost API │     │
│   └─────────────────────────────────┘     │
└───────────────────────────────────────────┘
```

### 技术架构图

```
┌───────────────────────────────────────────┐
│              应用层                        │
│   ┌─────────────────────────────────┐     │
│   │         Gin Web框架             │     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│              中间件层                      │
│   ┌─────────────────────────────────┐     │
│   │ 请求ID │ 错误处理 │ 访问控制     │     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│              核心服务层                    │
│   ┌─────────────────────────────────┐     │
│   │ 配置管理 │ 日志服务 │ 错误管理   │     │
│   └─────────────────────────────────┘     │
└───────────────────┬───────────────────────┘
                    │
                    ▼
┌───────────────────────────────────────────┐
│              工具库层                      │
│   ┌─────────────────────────────────┐     │
│   │ HTTP客户端 │ 日志库 │ 错误处理库 │     │
│   └─────────────────────────────────┘     │
└───────────────────────────────────────────┘
```

## 错误处理

系统实现了一套完整的错误处理机制，分为两种类型的错误：

1. **客户端错误(client_error)**: 由客户端引起的错误，如参数无效、资源不存在等。
2. **服务器错误(server_error)**: 系统内部错误，如数据库连接失败、API调用失败等。

错误配置集中在 `configs/errors.yaml` 文件中定义，包含错误代码、HTTP状态码、错误消息模板等。

错误处理流程：

1. 使用中间件捕获所有API请求处理过程中产生的错误
2. 将错误转换为标准的错误响应格式
3. 根据错误类型记录不同级别的日志
4. 对于服务器错误，隐藏敏感的错误详情，只返回基本错误信息
5. 在响应中包含请求ID，方便问题追踪

## 日志处理

系统使用 Uber 的 zap 日志库实现高性能日志记录，主要功能：

1. 支持多种日志级别(DEBUG, INFO, WARN, ERROR, FATAL, PANIC)
2. 支持日志轮转(log rotation)，通过 lumberjack 实现
3. 日志内容包含时间戳、日志级别、请求ID、错误详情等信息
4. 可通过配置文件调整日志行为，如文件大小、保留数量、保留天数等

日志配置位于 `application.toml` 的 `[log]` 部分：

```toml
[log]
logLevel = "debug"
useLogRotation = true
[log.logProps]
fileName = "./logs/aa.log"
maxSize = 1
maxBackups = 5
maxAge = 31
```

## API接口文档

系统集成了Swagger文档，可通过访问 `/swagger/*` 路径查看完整API文档。

### 主要API接口

#### 获取单个看板信息

```
GET /api/v1/focalboard/boards/single
```

**参数:**
- `boardId`: 看板ID (必填)
- `token`: 用户认证令牌 (必填)

**响应:**
成功响应(200):
```json
{
  "success": true,
  "data": {
    // 看板信息
  }
}
```

错误响应:
```json
{
  "success": false,
  "error": {
    "code": "错误代码",
    "message": "错误信息",
    "params": {
      "request_id": "请求ID"
    }
  }
}
```

## 开发指南

### 环境设置

1. 安装Go 1.16或更高版本
2. 克隆代码库
3. 安装依赖: `go mod download`

### 项目结构

```
├── configs/            # 配置文件目录
│   ├── application.toml # 应用配置
│   └── errors.yaml     # 错误定义
├── internal/           # 内部代码
│   ├── apimodel/       # API模型定义
│   ├── appconst/       # 应用常量
│   ├── conf/           # 配置处理
│   ├── dao/            # 数据访问层
│   ├── middleware/     # HTTP中间件
│   ├── model/          # 内部模型
│   ├── server/         # HTTP服务器
│   └── service/        # 业务逻辑
├── library/           # 工具库
│   ├── log/           # 日志处理
│   └── net/           # 网络工具
├── logs/              # 日志文件
├── pkg/               # 公共包
├── main.go            # 入口文件
├── go.mod             # Go模块定义
└── go.sum             # 依赖版本锁定
```

### 添加新API

1. 在 `internal/server/http` 中创建新的处理函数
2. 在 `route()` 函数中添加路由
3. 在 `internal/service` 中实现业务逻辑
4. 如需数据库访问，在 `internal/dao` 中添加相应方法

### 错误处理

添加新错误类型：
1. 在 `configs/errors.yaml` 中定义错误
2. 使用 `errors` 包中的方法创建具体错误

```go
// 使用示例
if token == "" {
    return errors.MissingParam("token")
}
```

### 配置管理

修改配置：
1. 在 `application.toml` 中添加配置项
2. 在 `internal/conf/conf.go` 中添加对应结构体字段

### 日志记录

使用日志：
```go
import "focalboard-tool/library/log"

// 记录不同级别的日志
log.Debug("调试信息")
log.Info("信息日志")
log.Warn("警告信息")
log.Error("错误信息", zap.Error(err))
```

## 部署指南

1. 编译应用: `go build -o focalboard-tool`
2. 配置 `configs/application.toml` 文件
3. 运行应用: `./focalboard-tool --config=configs/application.toml`

命令行参数:
- `--config` (`-c`): 配置文件路径
- `--expath` (`-e`): 额外配置文件路径 